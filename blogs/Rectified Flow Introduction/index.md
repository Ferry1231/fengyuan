

[toc]



发布于: 安徽
创建时间: 2025-3-3 21:25:18
点赞总数: 5
评论总数: 0
收藏总数: 8
喜欢总数: 0

本文主要介绍与解读Flow-Matching方法的经典之作：

[Flow Straight and Fast: Learning to Generate and Transfer Data with Rectified Flow](https://arxiv.org/abs/2209.03003)

可以在论文中找到的数学证明与参考文献暂略，文中图片来自于原论文。

## 0. 背景与前置知识

### 0.1 问题背景

生成模型的目标是学习从已知分布（如高斯噪声，均匀分布等）到未知分布（如图像、文本、视频等数据）的映射（Mapping），在实践中可以使用 **ODE** （ordinary differential equation）模型建模求解数据的变化与流动（flow）过程，达到最终转换分布的目的。但是一般情况下的ODE的概率路径都是弯曲（curve）的，这增加了模型的训练与采样难度，而Rectified Flow想通过 **在样本层面重新耦合** 的方法，使点对之间概率路径尽量”走直线“，提升整体训练与推理效率。

![多次Rectified Flow迭代产生的近似”直线“路径](images/2v2-df73fd18910b59b39f90f6fb14cdde99.jpg)

下面介绍论文中的问题背景- **传输映射问题** （The Transport Mapping Problem）：

给定两个分布：  `!$X_0 ～ \pi_0, X_1 ～ \pi_1$`  ，寻找一个传输映射  `!$T: \mathbb{R}^d \to \mathbb{R}^d $`  （较优或最优映射，对应最优传输），使得  `!$Z_0 ～ \pi_0$`  时， `!$Z_1 := T(Z_0) ～ \pi_1$`  ，并将  `!$(Z_0, Z_1)$`  称为  `!$\pi_0$`  和  `!$\pi_1$`  的一个耦合（coupling）

在生成模型领域，一般可以认为  `!$\pi_0$`  为噪声分布，  `!$\pi_1$`  为目标图像分布，最典型的例子就是扩散模型中的加噪过程（如VP，VE，sub-VP等）。生成模型实例如GAN，VAE，DDPM，都是在寻找满足如上条件的一个隐式定义的映射  `!$T$`  ，让噪声分布自然、快捷的”流动“到目标图像分布，比如ODE建模。从最优传输的角度看，生成质量好（能够完美的映射每个样本点到目标分布），采样效率高（少走弯路）是较优的映射，Rectified Flow从后者出发，想让样本点之间的演化路径尽量趋近直线，那便可以自然的提高效率。

### 0.2 前置知识

有关扩散模型部分默认读者是会的，在此不作介绍；

有关flow，flow-based与flow-matching的前置知识，可参考这篇文章：

[Ferry：Flow Matching相关原理](https://zhuanlan.zhihu.com/p/20571616124)

## 1. 方法概述

### 1.1 建模思想

给定分布：  `!$X_0 ～ \pi_0, X_1 ～ \pi_1$` ，在时间  `!$t \in [0, 1]$`  上可以用如下ODE建模演化过程：

 `!$ d Z_t = v(Z_t, t)\,dt \\$`  在这里，Rectified Flow想让漂移项  `!$v$`  尽可能的以”速度“  `!$(X_1 - X_0)$`  使数据点从  `!$\pi_0$`  流动到  `!$\pi_1$`  ，那么有如下优化目标：  `!$\min_v \int_0^1 E[||(X_1 - X_0) - v(X_t, t)||^2] dt \\$` ，其中  `!$X_t = t X_1 + (1 - t) X_0$`  为  `!$X_0, X_1$`  的线性插值，并且显然这满足  `!$d X_t = (X_1 - X_0) dt$`  ，也就是让速度场  `!$v(X_t, t)$`  尽可能的去拟合  `!$(X_1 - X_0) $`  。理想情况下，该ODE需要匀速直线前进，但是在实际情境如高维数据的学习中，很难出现呈直线的ODE演化路径，所以Rectified flow的目标也只是尽量的走直线-即找到更短的演化路径；

### 1.2 路径不相交定理（Picard–Lindelöf 定理）

如  `!$d Z_t = v(Z_t, t)\,dt$`  般定义的ODE，Rectified Flow假设该ODE的解是存在且唯一的，那么该ODE不同的路径在任何时间点都不会相交。如果其产生的不同的概率路径（不同的初始点）在某时刻有相交，那么意味着同一初始点可以演化出不同的轨迹，也就产生了不同的解，这与定义有矛盾。

Rectified Flow据此使用ODE方法对样本对进行重新耦合，构造出互不相交的演化路径。如果说线性插值是在初始分布与目标分布之间修路，那么Rectified Flow就是使各条道路互不相交的管理方法，也就是直接构建出确定性的（deterministic）点对  `!$(Z_0, Z_1)$`  ，从而省略了考虑如何连接  `!$X_0, X_1$`  的步骤，提升效率；

  

![Rectified Flow的重新耦合](images/3v2-5d5d12e43546d86b7c3806da6daa51de.jpg)

### 1.3 核心算法

此处直接使用论文中的伪代码：

![](images/4v2-534ac0829d8cb62c0c5aabe168322410.jpg)

## 2. 主要性质

### 2.1 边际保持性质

设  `!$Z_t$`  为Rectified Flow产生的序列，  `!$X_t$`  为线性插值产生的序列，那么在任何时刻  `!$t$`  ，  `!$Z_t$`  与  `!$X_t$`  的边际分布都相同。这里通过论文中的图形化证明可以很直观的看到，任何时刻  `!$Z_t$`  和  `!$X_t$`  的数据点流入流出量都相同：

![论文中的图形化证明](images/5v2-319f0206aa8fc83a5eba64aa7a10e087.jpg)

所以可以证明在任何时刻  `!$t $`  ，二者边缘分布相同，即  `!$Law(Z_t) = Law(X_t)$`  。

这让数据变得有因果（causal），可模拟，即可以使用ODE等方式进行求解。而我们的最终目标只是获得相同的目标分布，该方法使边缘分布保持不变，这达成了学习分布的目的；

### 2.2 降低传输损失

在最优传输中，将一个分布转换为另一个分布是需要代价的（想象从地上挖出一个土坑并堆成另一个土堆所耗费的力气），更低的代价无疑是更好的传输方式，即分布转换方式。在Rectified Flow方法中，产生的点对  `!$(Z_0, Z_1)$`  比原（non-causal）点对  `!$(X_0, X_1)$`  的平均代价更低，数学表述为：

 `!$E[c(Z_0, Z_1)] ≤ E[c(X_0, X_1)]\\$`  其中  `!$c$`  为凸传输代价（如L1 loss，L2 loss），文中通过Jensen不等式给出了上式的相关证明。

![论文中c = || · ||时的图形化证明](images/6v2-c1ef6a4f1f04c173d4ddbaf6ba9b0c94.jpg)

一个非常有趣的点是，Rectified Flow的优化目标（即上式）是一个Pareto优化问题，即是对全体点对损失均值的优化，而不是对某一点对进行优化（降低损失）：因为Rectified Flow创造了确定性的点对，若只是考虑某一点对的传输损失，那么有可能会使其他点对的损失升高，因此其需要对整体损失进行折衷，最后取得兼顾全局的Pareto最优解，而其他生成模型如VAE，GAN是假设各个数据点条件独立，考虑的则是单样本损失而不是 **点对配对关系** ；

### 2.3 Reflow：路径直线化与更快模拟

 **2.3.1 路径直线化** 

这是整篇文章的高光部分：为什么路径是直的？如果初始路径是曲线，那为什么能把其“拉直”？

首先观察一下Reflow的迭代方式：

 `!$Z^{K+1} = RectFlow(Z^K_0, Z^K_1) \\$`   `!$(Z^K_0, Z^K_1)$`  点对进行Reflow迭代产生新的序列  `!$[Z^{K+1}_0, ..., Z^{K+1}_t, ..., Z^{K+1}_1]$`  ，也就是说，每一次迭代是为了找到更接近直线路径的点对，而不是将原来的点对之间的路径拉直！

但很遗憾的是，几乎没有接近直线路径的点对，但是我们可以尽可能的使路径趋近于直线。作者在论文中给出了一种衡量路径“直度”的指标：

 `!$S(Z) = \int_0^1 \mathbb{E} [||(Z_1 - Z_0) - \dot Z_t||^2] dt\\$`  该值越接近0，“直度”越高。论文中还给出了迭代次数与直度的关系：

 `!$\min_{k \in {0, 1, ..., K}} S(Z^k) ≤ \frac {\mathbb{E}[||X_1 - X_0||^2] } {K} \\$` 

![迭代次数与“直度”的关系](images/7v2-9665ef2fe69277e0bc60416f2a9a1d29.jpg)

这说明理论上经过有限次能够以较低误差逼近直线路径。不过在实际训练中，由于误差的累积，多次迭代效果并不好，而2次迭代就已经能产生不错的效果。

 **2.3.2 更快模拟** 

从直观上来看，直线路径是更短的路径，并且直线路径可以在多次Reflow迭代之后采用单步Euler采样：  `!$Z_1 = Z_0 + v(z_0, 0)$`  ，能够大幅提升采样效率；

## 3. 非线性Rectified Flow

### 3.1 Rectified Flow视角下的统一框架

很多时候，使用ODE建模并不会使用线性插值方式（即插值系数并非  `!$t$`  的线性函数），比如DDPM的VE（variance-exploding），VP（variance-preserving），sub-VP等加噪方式。但某些非线性过程比如概率流ODE与DDIM在此情况下仍可使用Rectified Flow思想进行建模：

 `!$X = \{X_t, t \in [0, 1] \}$`  为时间可微序列，有ODE：

 `!$d Z_t = v^X(Z_t, t) dt \\$`  其中  `!$Z_0 = X_0$` ，  `!$v^X(Z_t, t) = \mathbb{E} [\dot X_t]$`  ，优化目标即为：

 `!$\min_v \int_0^1 E[w_t||v^X(X_t, t) - \dot X_t||^2] dt \\$`  这里的  `!$\dot X_t $`  代表着时刻  `!$t$`  的演化速度，目标仍然是去学习真实的速度场。

在非线性情况下，性质1即边际保持性质仍然成立，但此时无法保证Rectified Flow找到的点对  `!$(Z_0, Z_1)$`  的传输损失更低（注意这篇论文的背景是线性插值），也无法找到接近直线路径的点对；

### 3.2 概率流ODE与DDIM

在扩散模型中，ODE求解是对应SDE求解的更快速更直接的模式，三种经典的概率流ODE对应了三种SDE：VE（variance-exploding）SDE，VP（variance-preserving）SDE，sub-VP SDE，其中VP ODE可以视为与DDIM等价。

给定  `!$X_0 ～ \pi_0, X_1 ～ \pi_1$` ，概率流ODE可以写作：  `!$X_t = \alpha_t X_1 + \beta_t \epsilon \\$`  其中  `!$\epsilon$`  为标准高斯噪声，不同的  `!$\alpha_t, \beta_t$`  代表了不同的加噪方式，也即时间  `!$t$`  的选择方式，其中由于该过程不满足  `!$\alpha_1 = 1, \beta_t = 0$` 的条件，故设置 `!$X_0 = \alpha_0 X_1 + \beta_0 \epsilon$` 。

那么显然，加噪方式并不是必须从对应SDE形式中得出，概率流ODE可以自由选择加噪方式，比如线性插值；同时在Rectified Flow视角下还可以选择不同的初始分布  `!$\pi_0$` ，这对 **生成建模、数值优化、计算效率等方面都有重要意义** 。

![不同加噪策略的比较](images/8v2-e0b3221870968ecf79bfc08386b769e4.jpg)

  

原文地址：[Rectified Flow解读](https://zhuanlan.zhihu.com/p/26766739762) 


